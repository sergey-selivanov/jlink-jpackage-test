/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java application project to get you started.
 * For more details take a look at the 'Building Java & JVM projects' chapter in the Gradle
 * User Manual available at https://docs.gradle.org/6.8/userguide/building_java_projects.html
 */

plugins {
    id 'application'
    id 'eclipse'

    id 'org.beryx.jlink' version '2.23.1'

    id 'com.github.ben-manes.versions' version '0.36.0'
}

repositories {
    jcenter()
}

dependencies {
}

application {
    mainModule = 'jlinkjpackagetest'
    mainClass = 'jlink.jpackage.test.App'
}

if(!project.hasProperty('installerType')){
    project.ext.installerType = 'exe'
}

jlink {
    options = ['--compress', '2', '--no-header-files', '--no-man-pages', '--strip-native-commands']

    launcher {
        name = 'test launcher'
    }

    jpackage {
        installerType = project.ext.installerType

        appVersion = '0.0.1'

        // different imageName and installerName give error: "cannot find the file"

        imageName = 'test imageName'
        //imageName = 'test installerName'
        installerName = 'test installerName'

        installerOptions = [
            '--vendor', 'Sergey Selivanov',
            '--verbose'
        ]

        if (org.gradle.internal.os.OperatingSystem.current().windows) {

            installerOptions += [
                // saves generated wix files, clear dir names instead of temp
                '--temp',"${buildDir}/temp", // ? https://github.com/beryx/badass-runtime-plugin/issues/71


                '--win-menu', '--win-shortcut', '--win-dir-chooser',
                '--win-menu-group', 'Cook Book'
            ]
        }
        if (org.gradle.internal.os.OperatingSystem.current().linux) {
            installerOptions += [
                // TODO use imageName, not hardcoded path
                '--resource-dir', "build/jpackage/Cook Book/lib", // required for icon: https://github.com/beryx/badass-jlink-plugin/issues/148
                '--linux-shortcut', '--linux-menu-group', 'Other'
            ]

        }
    }
}


// https://discuss.gradle.org/t/how-to-set-the-module-path-project-jigsaw-for-eclipse-projects-via-gradle/26801/3
eclipse {
    classpath {
        file {
            whenMerged {
                entries.findAll { isModule(it) }.each {
                    it.entryAttributes['module'] = 'true'
                }
                entries.findAll { isSource(it) && isTestScope(it) }.each {
                    it.entryAttributes['test'] = 'true'
                }
                entries.findAll { isLibrary(it) && isTestScope(it) }.each {
                    it.entryAttributes['test'] = 'true'
                }
            }
        }
//        defaultOutputDir = file('build')
//        downloadSources = true
//        downloadJavadoc = true
    }
}

boolean isLibrary(entry) { return entry.properties.kind.equals('lib') }
boolean isTestScope(entry) { return entry.entryAttributes.get('gradle_used_by_scope').equals('test'); }
boolean isModule(entry) { isLibrary(entry) && !isTestScope(entry); }
boolean isSource(entry) { return entry.properties.kind.equals('src'); }
